<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tiled Matrix Transpose with Local Array &mdash; RAJA 2022.03.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Workgroup Constructs: Halo Exchange" href="halo-exchange.html" />
    <link rel="prev" title="Tiled Matrix Transpose" href="matrix_transpose_tiled.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> RAJA
            <img src="../../../_static/RAJA_LOGO_CMYK_White_Background_large.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.03
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">RAJA User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">Getting Started With RAJA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using_raja.html">Using RAJA in Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config_options.html">Build Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html">RAJA Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app_considerations.html">Application Considerations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../tutorial.html">RAJA Tutorial and Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#raja-tutorial">RAJA Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#a-little-c-background">A Little C++ Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#raja-examples-and-exercises">RAJA Examples and Exercises</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#simple-loops-and-basic-raja-features">Simple Loops and Basic RAJA Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#complex-loops-and-advanced-raja-features">Complex Loops and Advanced RAJA Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#nested-loops-with-raja-kernel">Nested Loops with <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#nested-loops-with-raja-expt-launch">Nested Loops with <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code></a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../tutorial.html#comparing-raja-kernel-and-raja-expt-launch-matrix-transpose">Comparing <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> and <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code>: Matrix-Transpose</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="matrix_transpose.html">Matrix Transpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="matrix_transpose_tiled.html">Tiled Matrix Transpose</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Tiled Matrix Transpose with Local Array</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html#other-raja-features-and-usage-examples">Other RAJA Features and Usage Examples</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide/index.html">RAJA Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raja_license.html">RAJA Copyright and License Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RAJA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">RAJA User Guide</a> &raquo;</li>
          <li><a href="../tutorial.html">RAJA Tutorial and Examples</a> &raquo;</li>
      <li>Tiled Matrix Transpose with Local Array</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/sphinx/user_guide/tutorial/matrix_transpose_local_array.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tiled-matrix-transpose-with-local-array">
<span id="tut-matrixtransposelocalarray-label"></span><h1>Tiled Matrix Transpose with Local Array<a class="headerlink" href="#tiled-matrix-transpose-with-local-array" title="Permalink to this headline">¶</a></h1>
<p>This section extends the discussion in <a class="reference internal" href="matrix_transpose_tiled.html#tut-tiledmatrixtranspose-label"><span class="std std-ref">Tiled Matrix Transpose</span></a>
by adding <em>local array</em> objects which are used to store data for each tile in
CPU stack-allocated arrays or GPU thread local and shared memory to be used
within kernels.</p>
<p>There are exercise files
<code class="docutils literal notranslate"><span class="pre">RAJA/exercises/kernel-matrix-transpose-local-array.cpp</span></code> and
<code class="docutils literal notranslate"><span class="pre">RAJA/exercises/launch-matrix-transpose-local-array.cpp</span></code> for you to work
through if you wish to get some practice with RAJA. The files
<code class="docutils literal notranslate"><span class="pre">RAJA/exercises/kernel-matrix-transpose-local-array._solutioncpp</span></code> and
<code class="docutils literal notranslate"><span class="pre">RAJA/exercises/launch-matrix-transpose-local-array_solution.cpp</span></code> contain
complete working code for the examples. You can use the solution files to
check your work and for guidance if you get stuck. To build
the exercises execute <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">(kernel/launch)-matrix-transpose-local-array</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">(kernel/launch)-matrix-transpose-local-array_solution</span></code>
from the build directory.</p>
<p>Key RAJA features shown in this example are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method and execution policy usage with multiple lambda expressions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::statement::Tile</span></code> type for loop tiling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> type for generating local tile indices</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> type for thread-local tile memory arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::launch</span></code> kernel execution interface</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::tile</span></code> type for loop tiling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop_icount</span></code> method to generate local tile indices for Launch</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA_TEAM_SHARED</span></code> macro for thread-local tile memory arrays</p></li>
</ul>
</div></blockquote>
<p>As in <a class="reference internal" href="matrix_transpose_tiled.html#tut-tiledmatrixtranspose-label"><span class="std std-ref">Tiled Matrix Transpose</span></a>, this example computes the
transpose of an input matrix <span class="math notranslate nohighlight">\(A\)</span> of size <span class="math notranslate nohighlight">\(N_r \times N_c\)</span> and
stores the result in a second matrix <span class="math notranslate nohighlight">\(At\)</span> of size <span class="math notranslate nohighlight">\(N_c \times N_r\)</span>.
The operation uses a local memory tiling algorithm, which tiles the outer
loops and iterates over tiles in inner loops. The algorithm first loads
input matrix entries into a local two-dimensional array for a tile, and then
reads from the tile swapping the row and column indices to generate the output
matrix.</p>
<p>We choose tile dimensions smaller than the dimensions of the matrix and note
that it is not necessary for the tile dimensions to divide evenly the number
of rows and columns in the matrix. As in the
<a class="reference internal" href="matrix_transpose_tiled.html#tut-tiledmatrixtranspose-label"><span class="std std-ref">Tiled Matrix Transpose</span></a> example, we start by defining the number
of rows and columns in the matrices, the tile dimensions, and the number of
tiles.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">267</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">251</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">outer_Dimc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">N_c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">outer_Dimr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">N_r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>We also use RAJA View objects to simplify the multi-dimensional indexing
as in the <a class="reference internal" href="matrix_transpose_tiled.html#tut-tiledmatrixtranspose-label"><span class="std std-ref">Tiled Matrix Transpose</span></a> example.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">RAJA</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">Layout</span><span class="o">&lt;</span><span class="n">DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Aview</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">N_r</span><span class="p">,</span><span class="w"> </span><span class="n">N_c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">RAJA</span><span class="o">::</span><span class="n">View</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">Layout</span><span class="o">&lt;</span><span class="n">DIM</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Atview</span><span class="p">(</span><span class="n">At</span><span class="p">,</span><span class="w"> </span><span class="n">N_c</span><span class="p">,</span><span class="w"> </span><span class="n">N_r</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The complete sequential C-style implementation of the tiled transpose operation
using a stack-allocated local array for the tiles is:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// (0) Outer loops to iterate over tiles</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outer_Dimr</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">by</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">outer_Dimc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">bx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="c1">// Stack-allocated local array for data on a tile</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">Tile</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span><span class="w"></span>

<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// (1) Inner loops to read input matrix tile data into the array</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">//     Note: loops are ordered so that input matrix data access</span>
<span class="w">      </span><span class="c1">//           is stride-1.</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span><span class="w">  </span><span class="c1">// Matrix column index</span>
<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span><span class="w">  </span><span class="c1">// Matrix row index</span>

<span class="w">          </span><span class="c1">// Bounds check</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N_r</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N_c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Tile</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Aview</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// (2) Inner loops to write array data into output array tile</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">//     Note: loop order is swapped from above so that output matrix</span>
<span class="w">      </span><span class="c1">//           data access is stride-1.</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tx</span><span class="p">;</span><span class="w">  </span><span class="c1">// Matrix column index</span>
<span class="w">          </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ty</span><span class="p">;</span><span class="w">  </span><span class="c1">// Matrix row index</span>

<span class="w">          </span><span class="c1">// Bounds check</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N_r</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N_c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Atview</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tile</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>To prevent indexing out of bounds, when the tile dimensions do not
divide evenly the matrix dimensions, we use a bounds check in the
inner loops.</p></li>
<li><p>For efficiency, we order the inner loops so that reading from
the input matrix and writing to the output matrix both use
stride-1 data access.</p></li>
</ul>
</div>
<section id="raja-kernel-variants">
<h2><code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> Variants<a class="headerlink" href="#raja-kernel-variants" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> interface provides mechanisms to tile loops and use
<em>local arrays</em> in kernels so that algorithm patterns like the C-style kernel
above can be implemented with RAJA. When using <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>, a
<code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> type specifies an object whose memory is created inside
a kernel using a statement type in a RAJA kernel execution policy. The local
array data is only usable within the kernel. See <a class="reference internal" href="../feature/local_array.html#feat-local-array-label"><span class="std std-ref">Local Array</span></a>
for more information.</p>
<p><code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> methods also support loop tiling statements which determine
the number of tiles needed to perform an operation based on tile size and
extent of the corresponding iteration space. Moreover, lambda expressions for
the kernel will not be invoked for iterations outside the bounds of an
iteration space when tile dimensions do not divide evenly the size of the
iteration space; thus, no conditional checks on loop bounds are needed
inside inner loops.</p>
<p>For the RAJA version of the matrix transpose kernel above, we define the
type of the <code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> used for matrix entries in a tile and
create an object to represent it:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">LocalArray</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">Perm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">SizeList</span><span class="o">&lt;</span><span class="n">TILE_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The template parameters that define the type are: the array data type, the
data stride permutation for the array indices (here the identity permutation
is given, so the default RAJA conventions apply; i.e., the rightmost array
index will be stride-1), and the array dimensions. Next, we compare two
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> implementations of the matrix transpose operation.</p>
<p>The complete RAJA sequential CPU variant with kernel execution policy and
kernel is:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">SEQ_EXEC_POL_I</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">KernelPolicy</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">      </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Tile</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">tile_fixed</span><span class="o">&lt;</span><span class="n">TILE_DIM</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Tile</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">tile_fixed</span><span class="o">&lt;</span><span class="n">TILE_DIM</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">InitLocalMem</span><span class="o">&lt;</span><span class="n">RAJA</span><span class="o">::</span><span class="n">cpu_tile_mem</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">ParamList</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">ForICount</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Param</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">ForICount</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Param</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">ForICount</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Param</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">ForICount</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Param</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="o">&gt;</span><span class="w"></span>

<span class="w">          </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">RAJA</span><span class="o">::</span><span class="n">kernel_param</span><span class="o">&lt;</span><span class="n">SEQ_EXEC_POL_I</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_c</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_r</span><span class="p">)),</span><span class="w"></span>

<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Tile_Array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Tile_Array</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Aview</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Tile_Array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Atview</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>In the execution policy, the <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Tile</span></code> types define
tiling of the outer ‘row’ (iteration space tuple index ‘1’) and ‘col’
(iteration space tuple index ‘0’) loops, as well as tile sizes
(<code class="docutils literal notranslate"><span class="pre">RAJA::tile_fixed</span></code> types) and loop execution policies. Next,
the <code class="docutils literal notranslate"><span class="pre">RAJA::statement::InitLocalMem</span></code> type allocates the local tile array
based on the memory policy type (here, we use <code class="docutils literal notranslate"><span class="pre">RAJA::cpu_tile_mem</span></code> for
a CPU stack-allocated array). The <code class="docutils literal notranslate"><span class="pre">RAJA::ParamList&lt;2&gt;</span></code> parameter indicates
that the local array object is associated with position ‘2’ in the parameter
tuple argument passed to the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method. The first two
entries in the parameter tuple indicate storage for the local tile indices
that are used in the two lambda expressions that comprise the kernel body.
Finally, we have two sets of nested inner loops for reading the input matrix
entries into the local tile array and writing them out to the output matrix
transpose. The inner bodies of each of these loop nests are identified by
lambda expression invocation statements <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda&lt;0&gt;</span></code> for
the first lambda passed as an argument to the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method
and <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda&lt;1&gt;</span></code> for the second lambda argument.</p>
<p>Note that the loops within tiles use <code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> types
rather than <code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> types that we saw in the
tiled matrix transpose example in <a class="reference internal" href="matrix_transpose_tiled.html#tut-tiledmatrixtranspose-label"><span class="std std-ref">Tiled Matrix Transpose</span></a>.
The <code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> type generates local tile indices that
are passed to lambda loop body expressions to index into the local tile
memory array. As the reader will observe, there is no local tile index
computation needed in the lambdas for the RAJA version of the kernel as a
result. The first integer template parameter for each
<code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> type indicates the item in the iteration space
tuple passed to the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method to which it applies.
The second template parameter for each
<code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> type indicates the position in the parameter
tuple passed to the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method that will hold the
associated local tile index. For more detailed discussion of RAJA loop tiling
statement types, please see <a class="reference internal" href="../feature/tiling.html#feat-tiling-label"><span class="std std-ref">Loop Tiling</span></a>.</p>
<p>Now that we have described the execution policy in some detail, let’s pull
everything together by briefly walking though the call to the
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method, which is similar to <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> but takes
additional arguments needed to execute the operations involving local
tile indices and the local memory array. The first argument is a tuple of
iteration spaces that define the iteration ranges for the levels in the loop
nest. Again, the first integer parameters given to the <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Tile</span></code>
and <code class="docutils literal notranslate"><span class="pre">RAJA::statement::ForICount</span></code> types identify the tuple entry to which
they apply. The second argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAJA</span><span class="p">::</span><span class="n">make_tuple</span><span class="p">((</span><span class="nb">int</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">Tile_Array</span><span class="p">)</span>
</pre></div>
</div>
<p>is a tuple of data parameters that will hold the local tile indices and
<code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> tile memory. The tuple entries are
associated with various statements in the execution policy as we described
earlier. Next, two lambda expression arguments are passed to the
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> method for reading and writing the input and output
matrix entries, respectively.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> accepts a parameter tuple argument after
the iteration space tuple, which enables the parameters to be
used in multiple lambda expressions in a kernel.</p>
</div>
<p>In the kernel, both lambda expressions take the same five arguments. The first
two are the matrix global column and row indices associated with the iteration
space tuple. The next three arguments correspond to the parameter tuple entries.
The first two of these are the local tile indices used to access entries in the
<code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> object memory. The last argument is a reference to the
<code class="docutils literal notranslate"><span class="pre">RAJA::LocalArray</span></code> object itself.</p>
<p>The next <code class="docutils literal notranslate"><span class="pre">RAJA::kernel_param</span></code> variant we present works the same as the one
above. It is different from the previous version since we include
additional template parameters in the <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> types to
indicate which arguments each lambda expression takes and in which order.
Here is the complete version including execution policy and kernel:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">SEQ_EXEC_POL_II</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">KernelPolicy</span><span class="o">&lt;</span><span class="w"></span>
<span class="w">      </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Tile</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">tile_fixed</span><span class="o">&lt;</span><span class="n">TILE_DIM</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Tile</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">tile_fixed</span><span class="o">&lt;</span><span class="n">TILE_DIM</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">InitLocalMem</span><span class="o">&lt;</span><span class="n">RAJA</span><span class="o">::</span><span class="n">cpu_tile_mem</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">ParamList</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Segs</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Segs</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Offsets</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Offsets</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Params</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">RAJA</span><span class="o">::</span><span class="n">statement</span><span class="o">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Segs</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Offsets</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Params</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">            </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">          </span><span class="o">&gt;</span><span class="w"></span>

<span class="w">          </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">      </span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">RAJA</span><span class="o">::</span><span class="n">kernel_param</span><span class="o">&lt;</span><span class="n">SEQ_EXEC_POL_II</span><span class="o">&gt;</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_c</span><span class="p">),</span><span class="w"></span>
<span class="w">                     </span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_r</span><span class="p">)),</span><span class="w"></span>

<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">Tile_Array</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Tile_Array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Tile_Array</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Aview</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>

<span class="w">    </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_MEM</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Tile_Array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">Atview</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Here, the two <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> types in the execution policy show
two different ways to specify the segments (<code class="docutils literal notranslate"><span class="pre">RAJA::Segs</span></code>)
associated with the matrix column and row indices. That is, we can use a
<code class="docutils literal notranslate"><span class="pre">Segs</span></code> statement for each argument, or include multiple segment ids in one
statement.</p>
<p>Note that we are using <code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> types for the inner tile
loops instead of <cite>RAJA::statement::ForICount`</cite> types used in the first variant.
As a consequence of specifying lambda arguments, there are two main differences.
The local tile indices are properly computed and passed to the lambda
expressions as a result of the <code class="docutils literal notranslate"><span class="pre">RAJA::Offsets</span></code> types that appear
in the lambda statement types. The <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> type for each
lambda shows the two ways to specify the local tile index arguments; we can
use an <code class="docutils literal notranslate"><span class="pre">Offsets</span></code> statement for each argument, or include multiple segment
ids in one statement. Lastly, there is only one entry in the parameter
tuple in this case, the local tile array. The placeholders in the
previous example are not needed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example, we need all five arguments in each lambda
expression so the lambda expression argument lists are
the same. Another use case for the template parameter argument
specification described here is to be able to pass only the
arguments used in a lambda expression. In particular when we use
multiple lambda expressions to represent a kernel, each lambda
can have a different argument lists from the others.</p>
</div>
</section>
<section id="raja-expt-launch-variants">
<h2><code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> Variants<a class="headerlink" href="#raja-expt-launch-variants" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> interface provides mechanisms to tile loops and use
<em>local arrays</em> in kernels to support algorithm patterns like the C-style kernel
above. When, using <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code>, the <code class="docutils literal notranslate"><span class="pre">RAJA_TEAM_SHARED</span></code> macro is
used to create a GPU shared memory array or a CPU stack memory array inside
a kernel.</p>
<p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> support methods for tiling over an iteration space
using <code class="docutils literal notranslate"><span class="pre">RAJA::expt::tile</span></code> and <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop_icount</span></code> methods to tile
loops and generate global iteration indices and local tile offsets.
Moreover, lambda expressions for these methods will not be invoked for
iterations outside the bounds of an iteration space when tile dimensions
do not divide evenly the size of the iteration space; thus, no conditional
checks on loop bounds are needed inside inner loops.</p>
<p>A complete RAJA sequential CPU variant with kernel execution policy and
kernel is:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">loop_pol_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">LoopPolicy</span><span class="o">&lt;</span><span class="n">RAJA</span><span class="o">::</span><span class="n">loop_exec</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">launch_policy_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">LaunchPolicy</span><span class="o">&lt;</span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">seq_launch_t</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">launch</span><span class="o">&lt;</span><span class="n">launch_policy_1</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">Grid</span><span class="p">(),</span><span class="w"> </span><span class="c1">//Grid may be empty when only running on the cpu</span>
<span class="w">    </span><span class="p">[</span><span class="o">=</span><span class="p">]</span><span class="w"> </span><span class="n">RAJA_HOST_DEVICE</span><span class="w"> </span><span class="p">(</span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">LaunchContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">      </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">tile</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_r</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">row_tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">tile</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">TILE_DIM</span><span class="p">,</span><span class="w"> </span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">N_c</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">RAJA</span><span class="o">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">col_tile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA_TEAM_SHARED</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">[</span><span class="n">TILE_DIM</span><span class="p">][</span><span class="n">TILE_DIM</span><span class="p">];</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">loop_icount</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">row_tile</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">loop_icount</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">col_tile</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">              </span><span class="n">Tile_Array</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Aview</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span><span class="w"></span>

<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">          </span><span class="p">});</span><span class="w"></span>

<span class="w">          </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">loop_icount</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">col_tile</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">RAJA</span><span class="o">::</span><span class="n">expt</span><span class="o">::</span><span class="n">loop_icount</span><span class="o">&lt;</span><span class="n">loop_pol_1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">row_tile</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">              </span><span class="n">Atview</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tile_Array</span><span class="p">[</span><span class="n">ty</span><span class="p">][</span><span class="n">tx</span><span class="p">];</span><span class="w"></span>

<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">          </span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">      </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">});</span><span class="w"></span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::tile</span></code> method is used to create tilings of the outer
‘row’ and ‘col’ iteration spaces. The <code class="docutils literal notranslate"><span class="pre">RAJA::expt::tile</span></code> method
takes an additional argument specifying the tile size for the corresponding
loop. To traverse the tile, we use the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop_icount</span></code> method,
which is similar to the <code class="docutils literal notranslate"><span class="pre">RAJA::ForICount</span></code> statement used in a
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> execution policy as shown above. A
<code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop_icount</span></code> method call
will generate local tile index associated with the outer global index.
The local tile index is necessary as we use it to read and write entries
from/to global memory to <code class="docutils literal notranslate"><span class="pre">RAJA_TEAM_SHARED</span></code> memory array.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="matrix_transpose_tiled.html" class="btn btn-neutral float-left" title="Tiled Matrix Transpose" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="halo-exchange.html" class="btn btn-neutral float-right" title="Workgroup Constructs: Halo Exchange" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Lawrence Livermore National Security, LLNS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>