<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elements of Loop Execution &mdash; RAJA 2022.03.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Policies" href="policies.html" />
    <link rel="prev" title="RAJA Features" href="../features.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> RAJA
            <img src="../../../_static/RAJA_LOGO_CMYK_White_Background_large.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.03
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">RAJA User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../getting_started.html">Getting Started With RAJA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../using_raja.html">Using RAJA in Your Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config_options.html">Build Configuration Options</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../features.html">RAJA Features</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Elements of Loop Execution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple-loops-raja-forall">Simple Loops (RAJA::forall)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-loops-raja-kernel">Complex Loops (RAJA::kernel)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hierarchical-loops-raja-expt-launch">Hierarchical loops (RAJA::expt::launch)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multi-dimensional-loops-using-simple-loop-apis-raja-combiningadapter">Multi-dimensional loops using simple loop APIs (RAJA::CombiningAdapter)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="policies.html">Policies</a></li>
<li class="toctree-l3"><a class="reference internal" href="iteration_spaces.html">Indices, Segments, and IndexSets</a></li>
<li class="toctree-l3"><a class="reference internal" href="view.html">View and Layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="reduction.html">Reduction Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic.html">Atomic Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="scan.html">Scan Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="sort.html">Sort Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="resource.html">Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="local_array.html">Local Array</a></li>
<li class="toctree-l3"><a class="reference internal" href="tiling.html">Loop Tiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="workgroup.html">WorkGroup</a></li>
<li class="toctree-l3"><a class="reference internal" href="vectorization.html">Vectorization (SIMD/SIMT)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html">Plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app_considerations.html">Application Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial.html">RAJA Tutorial and Examples</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide/index.html">RAJA Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raja_license.html">RAJA Copyright and License Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">RAJA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">RAJA User Guide</a> &raquo;</li>
          <li><a href="../features.html">RAJA Features</a> &raquo;</li>
      <li>Elements of Loop Execution</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/sphinx/user_guide/feature/loop_basic.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="elements-of-loop-execution">
<span id="loop-elements-label"></span><h1>Elements of Loop Execution<a class="headerlink" href="#elements-of-loop-execution" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>, <code class="docutils literal notranslate"><span class="pre">RAJA::expt::dynamic_forall</span></code>, <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>, and <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code>
template methods comprise the RAJA interface for kernel
execution. <code class="docutils literal notranslate"><span class="pre">forall</span></code> methods execute simple, non-nested loops,
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> methods support nested loops and other complex loop
kernels and transformations, and <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> creates an execution
space in which kernels are written in terms of nested loops using
the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop</span></code> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">forall</span></code> , and <code class="docutils literal notranslate"><span class="pre">kernel</span></code> methods are in the <code class="docutils literal notranslate"><span class="pre">RAJA</span></code>
namespace, while <code class="docutils literal notranslate"><span class="pre">dynamic_forall</span></code> and <code class="docutils literal notranslate"><span class="pre">launch</span></code> are in the RAJA namespace for
experimental features <code class="docutils literal notranslate"><span class="pre">RAJA::expt</span></code>.  <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code>
and <code class="docutils literal notranslate"><span class="pre">RAJA::expt::dynamic_forall</span></code> will be moved to the <code class="docutils literal notranslate"><span class="pre">RAJA</span></code> namespace in a future RAJA release.</p>
</div>
<p>For more information on RAJA execution policies and iteration space constructs,
see <a class="reference internal" href="policies.html#feat-policies-label"><span class="std std-ref">Policies</span></a> and <a class="reference internal" href="iteration_spaces.html#feat-index-label"><span class="std std-ref">Indices, Segments, and IndexSets</span></a>, respectively.</p>
<p>The following sections describe the basic aspects of these methods.
Detailed examples showing how to use <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>, <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>, <code class="docutils literal notranslate"><span class="pre">RAJA::launch</span></code> methods may be found in the <a class="reference internal" href="../tutorial.html#tutorial-label"><span class="std std-ref">RAJA Tutorial and Examples</span></a>. Links to specific
RAJA tutorial sections are provided in the sections below.</p>
<section id="simple-loops-raja-forall">
<span id="loop-elements-forall-label"></span><h2>Simple Loops (RAJA::forall)<a class="headerlink" href="#simple-loops-raja-forall" title="Permalink to this headline">¶</a></h2>
<p>Consider a C-style loop that adds two vectors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This may be written using <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAJA</span><span class="p">::</span><span class="n">forall</span><span class="o">&lt;</span><span class="n">exec_policy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">RAJA</span><span class="p">::</span><span class="n">TypesRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">});</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> loop execution method is a template that takes an
<em>execution policy</em> type template parameter. A <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> method takes
two arguments: an iteration space object, such as a contiguous range of loop
indices as shown here, and a single lambda expression representing the loop
kernel body.</p>
<p>Applying different loop execution policies enables the loop to run in
different ways; e.g., using different programming model back-ends. Different
iteration space objects enable the loop iterates to be partitioned, reordered,
run in different threads, etc. Please see <a class="reference internal" href="iteration_spaces.html#feat-index-label"><span class="std std-ref">Indices, Segments, and IndexSets</span></a> for details
about RAJA iteration spaces.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Changing loop execution policy types and iteration space constructs
enables loops to run in different ways by recompiling the code and
without modifying the loop kernel code.</p>
</div>
<p>As an extension of <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>, the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::dynamic_forall</span></code> method enables users
to compile using a list of execution policies and choose the execution policy at run-time.
For example, a user may want to have N policies available and at run-time choose which policy to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="n">exec_pol_list</span> <span class="o">=</span> <span class="n">camp</span><span class="p">::</span><span class="nb">list</span><span class="o">&lt;</span><span class="n">pol_0</span><span class="p">,</span>
                                  <span class="o">...</span>
                                 <span class="n">pol_N</span><span class="o">&gt;</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">pol</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="o">//</span><span class="n">run</span><span class="o">-</span><span class="n">time</span> <span class="n">value</span>

<span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">dynamic_forall</span><span class="o">&lt;</span><span class="n">exec_pol_list</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pol</span><span class="p">,</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">});</span>
</pre></div>
</div>
<p>While static loop execution using <code class="docutils literal notranslate"><span class="pre">forall</span></code> methods is a subset of
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> functionality, described next,
we maintain the <code class="docutils literal notranslate"><span class="pre">forall</span></code> interfaces for simple loop execution because the syntax is
simpler and less verbose for that use case.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Data arrays in lambda expressions used with RAJA are typically
RAJA Views (see <a class="reference internal" href="view.html#feat-view-label"><span class="std std-ref">View and Layout</span></a>) or bare pointers as shown in
the code snippets above. Using something like ‘std::vector’ is
non-portable (won’t work in GPU kernels, generally) and would add
excessive overhead for copying data into the lambda data environment
when captured by value.</p>
</div>
<p>Please see the following tutorial sections for detailed examples that use
<code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../tutorial/add_vectors.html#tut-addvectors-label"><span class="std std-ref">Basic Loop Execution: Vector Addition</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/dot_product.html#tut-dotproduct-label"><span class="std std-ref">Sum Reduction: Vector Dot Product</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/reductions.html#tut-reduction-label"><span class="std std-ref">Reduction Types and Kernels with Multiple Reductions</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/atomic_histogram.html#tut-atomichist-label"><span class="std std-ref">Atomic Operations: Computing a Histogram</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/indexset_segments.html#tut-indexset-label"><span class="std std-ref">Iteration Spaces: Segments and IndexSets</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/vertexsum_coloring.html#tut-vertexsum-label"><span class="std std-ref">Iteration Space Coloring: Mesh Vertex Sum</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/permuted-layout-batch-matrix-multiply.html#tut-permutedlayout-label"><span class="std std-ref">Permuted Layout: Batched Matrix-Multiplication</span></a></p></li>
</ul>
</div></blockquote>
</section>
<section id="complex-loops-raja-kernel">
<span id="loop-elements-kernel-label"></span><h2>Complex Loops (RAJA::kernel)<a class="headerlink" href="#complex-loops-raja-kernel" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> template provides ways to compose and execute arbitrary
loop nests and other complex kernels.
The <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> interface employs similar concepts to <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>
but extends it to support much more complex kernel structures.
Each <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> method is a template that takes an <em>execution policy</em>
type template parameter. The execution policy can be an arbitrarily complex
sequence of nested templates that define a kernel execution pattern.
In its simplest form, <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> takes two arguments:
a <em>tuple</em> of iteration space objects, and a lambda expression representing
the kernel inner loop body. In more complex usage, <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> can take
multiple lambda expressions representing different portions of the loop
kernel body.</p>
<p>To introduce the RAJA <em>kernel</em> interface, consider a (N+1)-level C-style loop
nest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">iN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iN</span> <span class="o">&lt;</span> <span class="n">NN</span><span class="p">;</span> <span class="o">++</span><span class="n">iN</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span>
     <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i0</span> <span class="o">&lt;</span> <span class="n">N0</span><span class="p">;</span> <span class="o">++</span><span class="n">i0</span><span class="p">)</span> <span class="p">{</span><span class="n">s</span>
       \\ <span class="n">inner</span> <span class="n">loop</span> <span class="n">body</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is important to note that we do not recommend writing a RAJA version of
this by nesting <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> statements. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAJA</span><span class="p">::</span><span class="n">forall</span><span class="o">&lt;</span><span class="n">exec_policyN</span><span class="o">&gt;</span><span class="p">(</span><span class="n">IN</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">iN</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span>
     <span class="n">RAJA</span><span class="p">::</span><span class="n">forall</span><span class="o">&lt;</span><span class="n">exec_policy0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I0</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i0</span><span class="p">))</span> <span class="p">{</span>
       \\ <span class="n">inner</span> <span class="n">loop</span> <span class="n">body</span>
     <span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This would work for some execution policy choices, but not in general.
Also, this approach treats each loop level as an independent entity, which
makes it difficult to parallelize the levels in the loop nest together. So it
may limit the amount of parallelism that can be exposed and the types of
parallelism that may be used. For example, if an OpenMP or CUDA
parallel execution policy is used on the outermost loop, then all inner loops
would be run sequentially in each thread. It also makes it difficult to perform
transformations like loop interchange and loop collapse without changing the
source code, which breaks RAJA encapsulation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>We do not recommend using nested ``RAJA::forall`` statements.</strong></p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> interface facilitates parallel execution and compile-time
transformation of arbitrary loop nests and other complex loop structures.
It can treat a complex loop structure as a single entity, which enables
the ability to transform and apply different parallel execution patterns by
changing the execution policy type and <strong>not the kernel code</strong>, in many cases.</p>
<p>The C-style loop above nest may be written using <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="n">KERNEL_POL</span> <span class="o">=</span>
  <span class="n">RAJA</span><span class="p">::</span><span class="n">KernelPolicy</span><span class="o">&lt;</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">For</span><span class="o">&lt;</span><span class="n">N</span><span class="p">,</span> <span class="n">exec_policyN</span><span class="p">,</span>
                        <span class="o">...</span>
                          <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">exec_policy0</span><span class="p">,</span>
                            <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
                          <span class="o">&gt;</span>
                        <span class="o">...</span>
                      <span class="o">&gt;</span>
                    <span class="o">&gt;</span><span class="p">;</span>

<span class="n">RAJA</span><span class="p">::</span><span class="n">kernel</span><span class="o">&lt;</span> <span class="n">KERNEL_POL</span> <span class="o">&gt;</span><span class="p">(</span>
  <span class="n">RAJA</span><span class="p">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">RAJA</span><span class="p">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NN</span><span class="p">),</span>
                   <span class="o">...</span><span class="p">,</span>
                   <span class="n">RAJA</span><span class="p">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N0</span><span class="p">),</span>

  <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">iN</span><span class="p">,</span> <span class="o">...</span> <span class="p">,</span> <span class="nb">int</span> <span class="n">i0</span><span class="p">)</span> <span class="p">{</span>
     <span class="o">//</span> <span class="n">inner</span> <span class="n">loop</span> <span class="n">body</span>
  <span class="p">}</span>

<span class="p">);</span>
</pre></div>
</div>
<p>In the case we discuss here, the execution policy contains a nested sequence
of <code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> types, indicating an iteration over each level in
the loop nest.  Each of these statement types takes three template parameters:</p>
<blockquote>
<div><ul class="simple">
<li><p>an integral index parameter that binds the statement to the item
in the iteration space tuple corresponding to that index</p></li>
<li><p>an execution policy type for the associated loop nest level</p></li>
<li><p>an <em>enclosed statement list</em> (described in <a class="reference internal" href="policies.html#loop-elements-kernelpol-label"><span class="std std-ref">RAJA Kernel Execution Policies</span></a>).</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The nesting of <code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> types is analogous to the
nesting of for-statements in the C-style version of the loop nest.
One can think of the ‘&lt;, &gt;’ symbols enclosing the template parameter
lists as being similar to the curly braces in C-style code.</p>
</div>
<p>Here, the innermost type in the kernel policy is a
<code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda&lt;0&gt;</span></code> type indicating that the first lambda expression
(argument zero of a sequence of lambdas passed to the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> method)
will comprise the inner loop body. We only have one lambda in this example
but, in general, we can have any number of lambdas and we can use any subset
of them, with <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> types placed appropriately in the
execution policy, to construct a loop kernel. For example, placing
<code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> types between <code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> statements
enables non-perfectly nested loops.</p>
<p>RAJA offers two types of <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> statements. The simplest
form, shown above, requires that each lambda expression passed to a
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> method <strong>must take an index argument for each iteration
space.</strong> With this type of lambda statement, the entire iteration space must
be active in a surrounding <code class="docutils literal notranslate"><span class="pre">For</span></code> construct.  A compile time <code class="docutils literal notranslate"><span class="pre">static_assert</span></code>
will be triggered if any of the arguments are undefined, indicating that
something is not correct.</p>
<p>A second <code class="docutils literal notranslate"><span class="pre">RAJA::statement::Lambda</span></code> type, which is an extension of the first,
takes additional template parameters which specify which iteration spaces
are passed as lambda arguments. The result is that a kernel lambda only needs
to accept iteration space index arguments that are used in the lambda body.</p>
<p>The kernel policy list with lambda arguments may be written as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="n">KERNEL_POL</span> <span class="o">=</span>
  <span class="n">RAJA</span><span class="p">::</span><span class="n">KernelPolicy</span><span class="o">&lt;</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">For</span><span class="o">&lt;</span><span class="n">N</span><span class="p">,</span> <span class="n">exec_policyN</span><span class="p">,</span>
                        <span class="o">...</span>
                          <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">For</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">exec_policy0</span><span class="p">,</span>
                            <span class="n">RAJA</span><span class="p">::</span><span class="n">statement</span><span class="p">::</span><span class="n">Lambda</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">Segs</span><span class="o">&lt;</span><span class="n">N</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="o">&gt;&gt;</span>
                          <span class="o">&gt;</span>
                        <span class="o">...</span>
                      <span class="o">&gt;</span>
                    <span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The template parameter <code class="docutils literal notranslate"><span class="pre">RAJA::Segs</span></code> is used to specify indices from which
elements in the segment tuple are passed as arguments to the lambda, and in
which argument order. Here, we pass all segment indices so the lambda kernel
body definition could be identical to on passed to the previous RAJA version.
RAJA offers other types such as <code class="docutils literal notranslate"><span class="pre">RAJA::Offsets</span></code>, and <code class="docutils literal notranslate"><span class="pre">RAJA::Params</span></code> to
identify offsets and parameters in segments and parameter tuples that could be
passed to <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> methods. See <a class="reference internal" href="../tutorial/matrix_multiply.html#tut-matrixmultiply-label"><span class="std std-ref">Matrix Multiplication: RAJA::kernel</span></a>
for an example.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless lambda arguments are specified in RAJA lambda statements,
the loop index arguments for each lambda expression used in a RAJA
kernel loop body <strong>must match</strong> the contents of the
<em>iteration space tuple</em> in number, order, and type. Not all index
arguments must be used in a lambda, but they <strong>all must appear</strong>
in the lambda argument list and <strong>all must be in active loops</strong> to be
well-formed. In particular, your code will not compile if this is
not done correctly. If an argument is unused in a lambda expression,
you may include its type and omit its name in the argument list to
avoid compiler warnings just as one would do for a regular C++
method with unused arguments.</p>
</div>
<p>For RAJA nested loops implemented with <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>, as shown here, the
loop nest ordering is determined by the order of the nested policies, starting
with the outermost loop and ending with the innermost loop.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The integer value that appears as the first parameter in each
<code class="docutils literal notranslate"><span class="pre">RAJA::statement::For</span></code> template indicates which iteration space
tuple entry or lambda index argument it corresponds to. <strong>This
allows loop nesting order to be changed simply by changing the
ordering of the nested policy statements</strong>. This is analogous to
changing the order of ‘for-loop’ statements in C-style nested loop
code.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In general, RAJA execution policies for <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> and
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> are different. A summary of all RAJA execution
policies that may be used with <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> or <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>
may be found in <a class="reference internal" href="policies.html#feat-policies-label"><span class="std std-ref">Policies</span></a>.</p>
</div>
<p>A discussion of how to construct <code class="docutils literal notranslate"><span class="pre">RAJA::KernelPolicy</span></code> types and
available <code class="docutils literal notranslate"><span class="pre">RAJA::statement</span></code> types can be found in
<a class="reference internal" href="policies.html#loop-elements-kernelpol-label"><span class="std std-ref">RAJA Kernel Execution Policies</span></a>.</p>
<p>Please see the following tutorial sections for detailed examples that use
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../tutorial/kernel_nested_loop_reorder.html#tut-kernelnestedreorder-label"><span class="std std-ref">Basic RAJA::kernel Mechanics and Nested Loop Ordering</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/kernel_exec_pols.html#tut-kernelexecpols-label"><span class="std std-ref">RAJA::kernel Execution Policies</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/matrix_transpose.html#tut-matrixtranspose-label"><span class="std std-ref">Matrix Transpose</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/offset-layout-5pt-stencil.html#tut-offsetlayout-label"><span class="std std-ref">OffsetLayout: Five-point Stencil</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/matrix_multiply.html#tut-matrixmultiply-label"><span class="std std-ref">Matrix Multiplication: RAJA::kernel</span></a></p></li>
</ul>
</div></blockquote>
</section>
<section id="hierarchical-loops-raja-expt-launch">
<h2>Hierarchical loops (RAJA::expt::launch)<a class="headerlink" href="#hierarchical-loops-raja-expt-launch" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> template is an alternative interface to
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> that may be preferred for certain types of complex kernels
or based on coding style preferences.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> will be moved out of the <code class="docutils literal notranslate"><span class="pre">expt</span></code> namespace
in a future RAJA release, after which it will appear as
<code class="docutils literal notranslate"><span class="pre">RAJA::launch</span></code>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> optionally allows either host or device execution
to be chosen at run time. The method takes an execution policy type that
will define the execution environment inside a lambda expression for a kernel
to be run on a host, device, or either. Kernel algorithms are written inside
main lambda expression using <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop</span></code> methods.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> framework aims to unify thread/block based
programming models such as CUDA/HIP/SYCL while maintaining portability on
host back-ends (OpenMP, sequential). As we showed earlier, when using the
<code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> interface, developers express all aspects of nested loop
execution in an execution policy type on which the <code class="docutils literal notranslate"><span class="pre">RAJA::kernel</span></code> method
is templated.
In contrast, the <code class="docutils literal notranslate"><span class="pre">RAJA::launch</span></code> interface allows users to express
nested loop execution in a manner that more closely reflects how one would
write conventional nested C-style for-loop code. For example, here is an
example of a <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> kernel that copies values from an array in
into a <em>shared memory</em> array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">launch</span><span class="o">&lt;</span><span class="n">launch_policy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">select_CPU_or_GPU</span><span class="p">)</span>
<span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">Grid</span><span class="p">(</span><span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">Teams</span><span class="p">(</span><span class="n">NE</span><span class="p">),</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">Threads</span><span class="p">(</span><span class="n">Q1D</span><span class="p">)),</span>
<span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="n">RAJA_HOST_DEVICE</span> <span class="p">(</span><span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">Launch</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">loop</span><span class="o">&lt;</span><span class="n">team_x</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">RAJA</span><span class="p">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">teamRange</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">bx</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">RAJA_TEAM_SHARED</span> <span class="n">double</span> <span class="n">s_A</span><span class="p">[</span><span class="n">SHARE_MEM_SIZE</span><span class="p">];</span>

    <span class="n">RAJA</span><span class="p">::</span><span class="n">expt</span><span class="p">::</span><span class="n">loop</span><span class="o">&lt;</span><span class="n">thread_x</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">RAJA</span><span class="p">::</span><span class="n">TypedRangeSegment</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">threadRange</span><span class="p">),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">s_A</span><span class="p">[</span><span class="n">tx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
    <span class="p">});</span>

      <span class="n">ctx</span><span class="o">.</span><span class="n">teamSync</span><span class="p">();</span>

 <span class="p">)};</span>

<span class="p">});</span>
</pre></div>
</div>
<p>The idea underlying <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> is to enable developers to express
hierarchical parallelism in terms of teams and threads. Similar to the CUDA
programming model, development is done using a collection of threads, and
threads are grouped into teams. Using the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop</span></code> methods
iterations of the loop may be executed by threads or teams depending on the
execution policy type. The launch context serves to synchronize threads within
the same team. The <code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> interface has three main concepts:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> template. This creates an execution environment in
which a kernel implementation is written using nested <code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop</span></code>
statements. The launch policy template parameter used with the
<code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code> method enables specification of both a host and
device execution environment, which enables run time selection of
kernel execution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::Grid</span></code> type. This type takes a number of teams and and a
number of threads as arguments.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RAJA::expt::loop</span></code> template. These are used to define hierarchical
parallel execution of a kernel. Operations within a loop are mapped to
either teams or threads based on the execution policy template parameter
provided.</p></li>
</ul>
</div></blockquote>
<p>Team shared memory is available by using the <code class="docutils literal notranslate"><span class="pre">RAJA_TEAM_SHARED</span></code> macro. Team
shared memory enables threads in a given team to share data. In practice,
team policies are typically aliases for RAJA GPU block policies in the
x,y,z dimensions, while thread policies are aliases for RAJA GPU thread
policies in the x,y,z dimensions. In a host execution environment, teams and
threads may be mapped to sequential loop execution or OpenMP threaded regions.
Often, the <code class="docutils literal notranslate"><span class="pre">RAJA::expt::Grid</span></code> method can take an empty argument list for
host execution.</p>
<p>Please see the following tutorial sections for detailed examples that use
<code class="docutils literal notranslate"><span class="pre">RAJA::expt::launch</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../tutorial/launch_basic.html#tut-launchintro-label"><span class="std std-ref">RAJA::expt::Launch Basics</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/launch_exec_pols.html#tut-launchexecpols-label"><span class="std std-ref">RAJA::expt::Launch Execution Policies</span></a></p></li>
<li><p><a class="reference internal" href="../tutorial/matrix_transpose.html#tut-matrixtranspose-label"><span class="std std-ref">Matrix Transpose</span></a></p></li>
</ul>
</div></blockquote>
</section>
<section id="multi-dimensional-loops-using-simple-loop-apis-raja-combiningadapter">
<span id="loop-elements-combiningadapter-label"></span><h2>Multi-dimensional loops using simple loop APIs (RAJA::CombiningAdapter)<a class="headerlink" href="#multi-dimensional-loops-using-simple-loop-apis-raja-combiningadapter" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">RAJA::CombiningAdapter</span></code> object provides ways to run perfectly nested loops
with simple loop APIs like <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> and those described in
<a class="reference internal" href="workgroup.html#workgroup-label"><span class="std std-ref">WorkGroup</span></a>.
To introduce the <code class="docutils literal notranslate"><span class="pre">RAJA</span> <span class="pre">::CombiningAdapter</span></code> interface, consider a (N+1)-level
C-style loop nest:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">iN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iN</span> <span class="o">&lt;</span> <span class="n">NN</span><span class="p">;</span> <span class="o">++</span><span class="n">iN</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span>
     <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i0</span> <span class="o">&lt;</span> <span class="n">N0</span><span class="p">;</span> <span class="o">++</span><span class="n">i0</span><span class="p">)</span> <span class="p">{</span>
       \\ <span class="n">inner</span> <span class="n">loop</span> <span class="n">body</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can use a <code class="docutils literal notranslate"><span class="pre">RAJA::CombiningAdapter</span></code> to combine the iteration spaces of the
loops and pass the adapter to a <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code> statement to execute them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auto</span> <span class="n">adapter</span> <span class="o">=</span> <span class="n">RAJA</span><span class="p">::</span><span class="n">make_CombingingAdapter</span><span class="p">(</span>
    <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="nb">int</span> <span class="n">iN</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="nb">int</span> <span class="n">i0</span><span class="p">))</span> <span class="p">{</span>
      \\ <span class="n">inner</span> <span class="n">loop</span> <span class="n">body</span>
    <span class="p">},</span> <span class="n">IN</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">I0</span><span class="p">);</span>

<span class="n">RAJA</span><span class="p">::</span><span class="n">forall</span><span class="o">&lt;</span><span class="n">exec_policy</span><span class="o">&gt;</span><span class="p">(</span><span class="n">adapter</span><span class="o">.</span><span class="n">getRange</span><span class="p">(),</span> <span class="n">adapter</span><span class="p">);</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">RAJA::CombiningAdapter</span></code> object is a template combining a loop body and
iteration spaces. The <code class="docutils literal notranslate"><span class="pre">RAJA::make_CombingingAdapter</span></code> template method takes
a lambda expression for the loop body and an arbitrary number of index
arguments. It provides a <em>flattened</em> iteration space via the <code class="docutils literal notranslate"><span class="pre">getRange</span></code>
method that can be passed as the iteration space to the <code class="docutils literal notranslate"><span class="pre">RAJA::forall</span></code>
method, for example. The object’s call operator does the conversion of the
flat single dimensional index into the multi-dimensional index space, calling
the provided lambda with the appropriate indices.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CombiningAdapter currently only supports
<code class="docutils literal notranslate"><span class="pre">RAJA::TypedRangeSegment</span></code> segments.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../features.html" class="btn btn-neutral float-left" title="RAJA Features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="policies.html" class="btn btn-neutral float-right" title="Policies" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, Lawrence Livermore National Security, LLNS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>