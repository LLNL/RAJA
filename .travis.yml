sudo: required
dist: trusty
language: cpp

matrix:
  include:
   - compiler: gcc
     addons:
       apt:
         sources:
           - ubuntu-toolchain-r-test
         packages:
           - g++-4.9
     env: COMPILER=g++-4.9
   - compiler: gcc
     addons:
       apt:
         sources:
           - ubuntu-toolchain-r-test
         packages:
           - g++-5
     env: COMPILER=g++-5
   - compiler: gcc
     addons:
       apt:
         sources:
           - ubuntu-toolchain-r-test
         packages:
           - g++-6
     env: COMPILER=g++-6
   - compiler: clang
     env: 
         - COMPILER=clang++-3.6
         - SPACK=llvm@3.6
   - compiler: clang
     env: 
         - COMPILER=clang++-3.7
         - SPACK=llvm@3.7
   - compiler: clang
     env: 
         - COMPILER=clang++-3.8
         - SPACK=llvm@3.8
cache:
    directories:
        - $HOME/spack
before_install:
  - sudo apt-get update -qq
  - git clone https://github.com/LLNL/spack $HOME/spack
  - [[ ! -z "$SPACK" ]] && $HOME/spack/bin/spack install $SPACK
script:
  - cd $TRAVIS_BUILD_DIR
  - mkdir travis-build && cd travis-build
  - if [[ -z "$SPACK" ]] ; then cmake ../ -DCMAKE_CXX_COMPILER="$COMPILER" ; else $HOME/spack/bin/spack env $SPACK cmake ../ -DCMAKE_CXX_COMPILER="$COMPILER" ; fi
  - make -j
  - make test # currently does nothing, this is how testing should be done
  - ./test/unit-tests/CPUtests/CPUnested-test.exe | tee test.out
  - grep "All Tests" test.out | sed -e 's/.* \([0-9]\+\) \/ \([0-9]\+\)$/\1\t\2/' | awk '{print $1 "/" $2; exit !($1 == $2)}'
  - ./test/unit-tests/CPUtests/CPUnested_reduce-test.exe | tee test.out
  - grep "All Tests" test.out | sed -e 's/.* \([0-9]\+\) \/ \([0-9]\+\)$/\1\t\2/' | awk '{print $1 "/" $2; exit !($1 == $2)}'
  - ./test/unit-tests/CPUtests/CPUreduce-test.exe | tee test.out
  - grep "All Tests" test.out | sed -e 's/.* \([0-9]\+\) \/ \([0-9]\+\)$/\1\t\2/' | awk '{print $1 "/" $2; exit !($1 == $2)}'
  - ./test/unit-tests/CPUtests/CPUtraversal-test.exe | tee test.out
  - grep "All Tests" test.out | sed -e 's/.* \([0-9]\+\) \/ \([0-9]\+\)$/\1\t\2/' | awk '{print $1 "/" $2; exit !($1 == $2)}'

